<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>滴答办公系统-角色列表</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet"
          href="/media/layui/css/layui.css"
          media="all">
    <script src="/media/js/jquery.min.js"></script>

    <script src="/media/layui/layui.js"></script>

    <script type="text/javascript">
        function deleteCourse(id){
            layui.use('table', function() {
                layer.confirm('是否确认删除角色?',function(index) {
                    $.ajax({
                        type:"POST",
                        url:"/role/deleteRole/"+id,
                        dataType:"json",
                        success:function(result){
                            if(result==true){
                                layer.msg("删除成功", {icon : 6});
                            }else{
                                layer.msg("该角色有人担任，删除失败", {icon : 5});
                            }
                            window.setTimeout("window.location.reload();",1000);

                        }

                    });
                });
            });
        }

        //选取二级菜单该对应的一级菜单被选中

        var form;
        var m ;
        function updateRoles(id){
            //回显所有菜单与权限
            $.get("/role/goUpdate/"+id, null, function(obj) {
                var r = obj.role;
                $("#id_update").val(r.id);
                $("#name_update").val(r.name);
                $("#remark_update").val(r.remark);
                //获取菜单
                m= obj.menus;
                for(var i=0;i<m.length;i++){
                    if(m[i].parentid==0){
                        if(m[i].flag==true){
                            $("#dv1_menus_update").append("<input type='checkbox' name='menu_id' value='"+m[i].id+"' title='"+m[i].name+"' checked id='menu_one_"+m[i].id+"'>");
                        }else{
                            $("#dv1_menus_update").append("<input type='checkbox' name='menu_id' value='"+m[i].id+"' title='"+m[i].name+"' id='menu_one_"+m[i].id+"'>");
                        }
                        for(var j=0;j<m.length;j++){
                            if(m[j].parentid==m[i].id){
                                if(m[j].flag==true){
                                    $("#dv1_menus_update").append("<br/>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='menu_id' value='"+m[j].id+"' title='"+m[j].name+"' checked lay-filter='menu_two_"+m[i].id+"' >");
                                }else{
                                    $("#dv1_menus_update").append("<br/>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='menu_id' value='"+m[j].id+"' title='"+m[j].name+"' lay-filter='menu_two_"+m[i].id+"' >");
                                }

                            }
                        }
                    }

                }
                //获取权限
                var p = obj.permissions;
                for(var k=0;k<p.length;k++){
                    if(p[k].flag==true){
                        $("#dv1_permission_update").append("<input type='checkbox' name='permission_id' value='"+p[k].id+"' title='"+p[k].name+"' checked>");
                    }else{
                        $("#dv1_permission_update").append("<input type='checkbox' name='permission_id' value='"+p[k].id+"' title='"+p[k].name+"'>");
                    }


                }

                layui.use('table', function() {
                    form=layui.form;
                    //for(var i=0;i<m.length;i++){
                    //	form.on("checkbox(menu_two_"+m[i].id+")", function (obj) {
                    //		dianji(m[i].id);
                    //	});
                    //}
                    layer.open({
                        area: ['500px', '480px'],
                        title: '更新角色',
                        type: 1,
                        content: $('#dvlay_update'), //这里content是一个普通的String
                        btn: ['更新', '取消'],
                        yes:function(index,layero){
                            $.ajax({
                                type:"POST",
                                url:"/role/update",
                                data:$("#fm1_update").serialize(),
                                dataType:"json",
                                success:function(result){
                                    if(result==true){
                                        layer.msg("更新成功", {icon : 6},function(){
                                            window.location.reload();
                                        });
                                    }else{
                                        layer.msg("更新失败", {icon : 5});
                                    }
                                }

                            });
                            layer.close(index);//关闭窗口
                        },
                        cancel: function() {}
                    });
                });
            });

        }

        //选择二级菜单，对应的一级菜单被选中
        function dianji(id) {
            alert(id);
            $("#menu_one_"+id).attr("checked",checked);
        }
        function addRole(){
            //回显所有菜单与权限
            $.get("/role/getMenusAndPermisions", null, function(obj) {
                //获取菜单
                var m = obj.menus;
                for(var i=0;i<m.length;i++){
                    if(m[i].parentid==0){
                        $("#dv1_menus_add").append("<input type='checkbox' name='menu_id' value='"+m[i].id+"' title='"+m[i].name+"'>");
                        for(var j=0;j<m.length;j++){
                            if(m[j].parentid==m[i].id){
                                $("#dv1_menus_add").append("<br/>&nbsp;&nbsp;&nbsp;&nbsp;<input type='checkbox' name='menu_id' value='"+m[j].id+"' title='"+m[j].name+"'>");
                            }
                        }
                    }
                }
                //获取权限
                var p = obj.permissions;
                for(var k=0;k<p.length;k++){
                    $("#dv1_permission_add").append("<input type='checkbox' name='permission_id' value='"+p[k].id+"' title='"+p[k].name+"'>");
                }

                layui.use('table', function() {
                    form=layui.form;
                    layer.open({
                        area: ['500px', '480px'],
                        title: '添加角色',
                        type: 1,
                        content: $('#dvlay_add'), //这里content是一个普通的String
                        btn: ['新增', '取消'],
                        yes:function(index,layero){
                            $.ajax({
                                type:"POST",
                                url:"/role/addRoles",
                                data:$("#fm1_add").serialize(),
                                dataType:"json",
                                success:function(result){
                                    if(result==true){
                                        layer.msg("新增成功", {icon : 6},function(){
                                            window.location.reload();
                                        });
                                    }else{
                                        layer.msg("新增失败", {icon : 5});
                                    }
                                }

                            });
                            layer.close(index);//关闭窗口
                        },
                        cancel: function() {}
                    });
                });
            });


        }

        //跳转页面
        function goPage(pageIndex) {
            location.href="/role/list/"+pageIndex+"?pageSize=5";
        }
        //改变页面大小
        function changePageSize(obj) {
            var page = obj.value;
            location.href="/role/list/1?pageSize="+page;
        }

        //跳转指定页面
        function tiaozhuan(totalPage) {
            //获取输入框内容
            var pageIndex = $("#page").val();
            var regex = new RegExp(/^[\d]+$/);
            var bool = regex.test(pageIndex);
            if(bool){
                if(pageIndex>totalPage||pageIndex<1){
                    alert("输入页码不在范围内！请重新输入~");
                    $("#page").focus();
                }else{
                    location.href="/role/list/"+pageIndex;
                }
            }else{
                alert("输入不合法！请重新输入~");
                $("#page").focus();
            }

        }
        $(function() {
            $("#pageSize").val(5);
        });
    </script>
</head>
<body>
<div class="layui-container">
    <div class="layui-btn-group">
        <button class="layui-btn layui-btn-norma" onclick="addRole();">
            <i class="layui-icon">&#xe654;</i>添加角色
        </button>
    </div>
</div>
<div class="layui-container">
    <table class="layui-table" id="tbdata" lay-filter="tbop">
        <thead>
        <tr>
            <td>序号</td>
            <td>角色名称</td>
            <td>角色备注</td>
            <td>操作</td>
        </tr>
        </thead>
        <tbody>

        <tr>
            <td>1</td>
            <td>系统管理员</td>
            <td>管理系统</td>
            <td><a class="layui-btn layui-btn-mini" href="#"
                   onclick="updateRoles(1);">编辑</a> <a
                    class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del"
                    onclick="deleteCourse(1);">删除</a></td>
        </tr>

        <tr>
            <td>2</td>
            <td>班主任</td>
            <td>教务管理</td>
            <td><a class="layui-btn layui-btn-mini" href="#"
                   onclick="updateRoles(2);">编辑</a> <a
                    class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del"
                    onclick="deleteCourse(2);">删除</a></td>
        </tr>

        <tr>
            <td>3</td>
            <td>讲师</td>
            <td>上课</td>
            <td><a class="layui-btn layui-btn-mini" href="#"
                   onclick="updateRoles(3);">编辑</a> <a
                    class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del"
                    onclick="deleteCourse(3);">删除</a></td>
        </tr>

        <tr>
            <td>7</td>
            <td>学生</td>
            <td>听课</td>
            <td><a class="layui-btn layui-btn-mini" href="#"
                   onclick="updateRoles(7);">编辑</a> <a
                    class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del"
                    onclick="deleteCourse(7);">删除</a></td>
        </tr>

        <tr>
            <td>8</td>
            <td>辅导员</td>
            <td>管理</td>
            <td><a class="layui-btn layui-btn-mini" href="#"
                   onclick="updateRoles(8);">编辑</a> <a
                    class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del"
                    onclick="deleteCourse(8);">删除</a></td>
        </tr>

        </tbody>
    </table>
    <div class="layui-box layui-laypage layui-laypage-default"
         id="layui-laypage-1">

        <a href="javascript:;" class="layui-laypage-prev layui-disabled"
           data-page="0"> <i class="layui-icon">&lt;</i>
        </a>





        <span style="color: #009688; font-weight: bold;">1</span>




        <a href="javascript:;" class="layui-laypage-next layui-disabled"
           data-page="2"> <i class="layui-icon">&gt;</i>
        </a>


			<span class="layui-laypage-skip">到第 <input type="text" min="1"
                                                       class="layui-input" id="page" value="1">页
				<button type="button" class="layui-laypage-btn"
                        onclick="tiaozhuan(1);">确定</button>
			</span> <span class="layui-laypage-count">共5条</span>
			<span class="layui-laypage-limits"> <select
                    onchange="changePageSize(this)" id="pageSize">
					<option value="5" selected>5条/页</option>
					<option value="10">10 条/页</option>
					<option value="15">15 条/页</option>
			</select>
			</span>
    </div>
</div>



</body>
</html>


<div style="display: none; margin-top: 10px; width: 480px"
     id="dvlay_update">
    <form id="fm1_update" class="layui-form layui-form-pane">
        <div class="layui-form-item" pane>
            <label class="layui-form-label">角色名称：</label>
            <div class="layui-input-inline">
                <input type="hidden" name="id" id="id_update"/>
                <input name="name" class="layui-input" id="name_update">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">角色备注：</label>
            <div class="layui-input-inline">
                <input name="remark" class="layui-input" id="remark_update">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">菜单：</label>
            <div class="layui-input-inline" id="dv1_menus_update">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">权限：</label>
            <div class="layui-input-inline" id="dv1_permission_update">
            </div>
        </div>
    </form>
</div>



<div style="display: none; margin-top: 10px; width: 480px"
     id="dvlay_add">
    <form id="fm1_add" class="layui-form layui-form-pane">
        <div class="layui-form-item" pane>
            <label class="layui-form-label">角色名称：</label>
            <div class="layui-input-inline">
                <input id="uid1" name="name" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">角色备注：</label>
            <div class="layui-input-inline">
                <input id="uid" name="remark" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">菜单：</label>
            <div class="layui-input-inline" id="dv1_menus_add">
            </div>
        </div>
        <div class="layui-form-item" pane>
            <label class="layui-form-label">权限：</label>
            <div class="layui-input-inline" id="dv1_permission_add"></div>
        </div>
    </form>
</div>